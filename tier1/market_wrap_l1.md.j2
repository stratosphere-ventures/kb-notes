{# =========================
  market_wrap_l1.md.j2
  Layer-1: deterministic outcomes + attributed event timeline + evidence pointers
  No commentary, no causality, no “drivers”.
========================= #}

{% set g = day.governance %}
---
doc_type: market_wrap_l1
doc_id: {{ g.doc_id | default("mw_" ~ (g.region|lower) ~ "_" ~ g.date) }}
doc_key: {{ g.doc_key | default("market_wrap/" ~ (g.region|lower) ~ "/" ~ g.date) }}
doc_version: {{ g.doc_version }}
is_current: {{ "true" if (g.is_current | default(true)) else "false" }}
is_active: {{ "true" if (g.is_active | default(true)) else "false" }}
published_ts: {{ g.published_ts }}
asof_ts: {{ g.asof_ts }}
market_session: {{ g.market_session }}
region: {{ g.region }}
universe_scope: {{ g.universe_scope }}
trust_tier: {{ g.trust_tier }}
license_policy: {{ g.license_policy }}
market_data_vendor: {{ g.market_data_vendor }}
market_data_version: {{ g.market_data_version }}
calc_versions:
{% for v in (g.calc_versions | default([])) %}
  - {{ v }}
{% endfor %}
pipeline_version: {{ g.pipeline_version }}
{% if g.sources_used is defined %}
sources_used:
{% for s in g.sources_used %}
  - source_name: {{ s.source_name }}
    source_type: {{ s.source_type }}
{% if s.count is defined %}
    count: {{ s.count }}
{% endif %}
{% if s.max_age_days is defined %}
    max_age_days: {{ s.max_age_days }}
{% endif %}
{% endfor %}
{% endif %}
---

<!-- chunk_id: wrap_summary -->
## 1) Executive Fact Summary

### 1.1 Headline (Neutral)
{{ day.market_outcomes.headline_neutral }}

### 1.2 Index / Benchmark Closes
{% for idx in (day.market_outcomes.indices | default([])) %}
- **{{ idx.symbol }}**: {{ "%.2f"|format(idx.close) }} ({{ "%+.2f"|format(idx.return_pct) }}%)
{% if idx.low is defined and idx.high is defined %}
  - Range: {{ "%.2f"|format(idx.low) }} – {{ "%.2f"|format(idx.high) }}
{% endif %}
{% endfor %}

### 1.3 Rates / FX / Commodities
{% set rfc = day.market_outcomes.rates_fx_commodities | default([]) %}
{% if rfc|length == 0 %}
- (none)
{% else %}
{% for r in rfc %}
- **{{ r.symbol }}**: {{ r.value }}
{% if r.unit == "pct" %}%{% elif r.unit == "bps" %} bps{% elif r.unit == "usd" %} USD{% elif r.unit == "index" %}{% elif r.unit == "ratio" %}{% endif %}
{% if r.change_bps is defined %}
  - Change: {{ "%+g"|format(r.change_bps) }} bps
{% elif r.change_pct is defined %}
  - Change: {{ "%+g"|format(r.change_pct) }}%
{% elif r.change_abs is defined %}
  - Change: {{ "%+g"|format(r.change_abs) }}
{% elif r.change is defined %}
  {# backward-compat: interpret 'change' based on unit #}
  {% if r.unit == "pct" %}
  - Change: {{ "%+g"|format(r.change) }} bps
  {% else %}
  - Change: {{ "%+g"|format(r.change) }}
  {% endif %}
{% endif %}
{% endfor %}
{% endif %}

### 1.4 Volatility
{% for v in (day.market_outcomes.volatility | default([])) %}
- **{{ v.symbol }}**: {{ "%.2f"|format(v.close) }}
{% if v.change_pts is defined %}
  - Change: {{ "%+.2f"|format(v.change_pts) }} pts
{% elif v.change is defined %}
  - Change: {{ "%+.2f"|format(v.change) }} pts
{% endif %}
{% endfor %}

### 1.5 Breadth
{% set b = day.market_outcomes.breadth | default({}) %}
- Advancers: {{ b.advancers }}
- Decliners: {{ b.decliners }}
{% if b.pct_above_200dma is defined %}
- % above 200DMA: {{ "%.1f"|format(b.pct_above_200dma) }}%
{% endif %}

<!-- chunk_id: wrap_timeline -->
## 2) Session Timeline (Attributed Events)

{% for e in (day.events | default([]) | sort(attribute="published_ts")) %}
### {{ e.published_ts }} — {{ e.event_type }}
- **Event ID**: {{ e.event_id }}
- **Session**: {{ e.market_session }}
- **Entities**: {{ (e.entities | default([])) | join(", ") }}
- **Facts**:
{% for f in (e.facts | default([])) %}
  - {{ f }}
{% endfor %}
- **Source**: {{ e.source.name }} ({{ e.source.source_type }})
- **URL**: {{ e.source.canonical_url }}

{% endfor %}

<!-- chunk_id: wrap_reactions -->
## 3) Measured Market Reactions

### 3.1 Reaction Windows (grouped by event_id)

{# Constraints: keep this readable and enforce determinism downstream via validation #}
{% set core = ["SPX","NDX","DJIA","RUT","VIX"] %}
{% set allowed_windows = ["t0_to_t+5m","t0_to_t+30m","t0_to_t+60m","t0_to_close","pre_to_close"] %}

{% for e in (day.events | default([]) | sort(attribute="published_ts")) %}
{% set eid = e.event_id %}
#### Event {{ eid }} ({{ e.event_type }} at {{ e.published_ts }})

{# Core instruments first #}
{% for w in allowed_windows %}
{% for rw in (day.reaction_windows | default([])) if rw.event_id == eid and rw.window == w and rw.instrument in core %}
- **{{ rw.instrument }}** — Window {{ rw.window }}: {{ "%+.3f"|format(rw.move_pct) }}%
{% endfor %}
{% endfor %}

{# Then a capped set of non-core instruments #}
{% set extras = (day.reaction_windows | default([]) | selectattr("event_id","equalto",eid) | list) %}
{% set printed = 0 %}
{% for rw in extras %}
{% if rw.instrument not in core and rw.window in allowed_windows %}
{% if printed < 8 %}
- **{{ rw.instrument }}** — Window {{ rw.window }}: {{ "%+.3f"|format(rw.move_pct) }}%
{% set printed = printed + 1 %}
{% endif %}
{% endif %}
{% endfor %}

{% endfor %}

<!-- chunk_id: wrap_movers_sectors -->
## 4) Movers and Sectors

### 4.1 Top Movers
**Top Gainers**
{% for m in (day.movers.top_gainers | default([])) %}
- {{ m.symbol }}: {{ "%+.2f"|format(m.return_pct) }}% ({{ "%.2f"|format(m.volume_multiple) }}× avg volume){% if m.sector is defined %} — {{ m.sector }}{% endif %}
{% endfor %}

**Top Decliners**
{% for m in (day.movers.top_decliners | default([])) %}
- {{ m.symbol }}: {{ "%+.2f"|format(m.return_pct) }}% ({{ "%.2f"|format(m.volume_multiple) }}× avg volume){% if m.sector is defined %} — {{ m.sector }}{% endif %}
{% endfor %}

### 4.2 Sector Performance
| Sector | Return | Volume Multiple |
|---|---:|---:|
{% for s in (day.sectors | default([])) %}
| {{ s.name }} | {{ "%+.2f"|format(s.return_pct) }}% | {{ "%.2f"|format(s.volume_multiple) }}× |
{% endfor %}

<!-- chunk_id: wrap_ticker_panels -->
## 5) Company Fact Panels

{% for t in (day.tickers | default([])) %}
### {{ t.symbol }}
- **Close**: {{ "%.2f"|format(t.close) }} ({{ "%+.2f"|format(t.return_pct) }}%)
- **Volume**: {{ "%.2f"|format(t.volume_multiple) }}× avg
- **Technicals**:
  - SMA(50): {{ "%.2f"|format(t.technicals.sma_50) }}
  - SMA(200): {{ "%.2f"|format(t.technicals.sma_200) }}
  - RSI(14): {{ "%.1f"|format(t.technicals.rsi_14) }}
- **Company Filings Identified**: {{ "true" if t.filings_identified else "false" }}

{% endfor %}

<!-- chunk_id: wrap_evidence -->
## 6) Evidence Appendix

```yaml
evidence_items:
{% for ev in (day.evidence_items | default([])) %}
  - event_id: {{ ev.event_id }}
    source_name: {{ ev.source_name }}
    source_type: {{ ev.source_type }}
    published_ts: {{ ev.published_ts }}
    canonical_url: "{{ ev.canonical_url }}"
    excerpt: "{{ (ev.excerpt | replace('\\\\', '\\\\\\') | replace('\"', '\\\"') | replace('\\n', ' ') ) }}"
    doc_id: {{ ev.doc_id }}
    chunk_id: {{ ev.chunk_id }}
{% endfor %}


{% set g = day.governance %}
---
doc_type: market_wrap_l1
doc_id: {{ g.doc_id | default("mw_" ~ g.region|lower ~ "_" ~ g.date) }}
doc_key: {{ g.doc_key | default("market_wrap/" ~ g.region|lower ~ "/" ~ g.date) }}
doc_version: {{ g.doc_version }}
is_current: {{ "true" if (g.is_current | default(true)) else "false" }}
is_active: {{ "true" if (g.is_active | default(true)) else "false" }}
published_ts: {{ g.published_ts }}
asof_ts: {{ g.asof_ts }}
market_session: {{ g.market_session }}
region: {{ g.region }}
universe_scope: {{ g.universe_scope }}
trust_tier: {{ g.trust_tier }}
license_policy: {{ g.license_policy }}
market_data_vendor: {{ g.market_data_vendor }}
market_data_version: {{ g.market_data_version }}
calc_versions:
{% for v in g.calc_versions %}
  - {{ v }}
{% endfor %}
pipeline_version: {{ g.pipeline_version }}
{% if g.sources_used is defined %}
sources_used:
{% for s in g.sources_used %}
  - source_name: {{ s.source_name }}
    source_type: {{ s.source_type }}
{% if s.count is defined %}
    count: {{ s.count }}
{% endif %}
{% if s.max_age_days is defined %}
    max_age_days: {{ s.max_age_days }}
{% endif %}
{% endfor %}
{% endif %}
---

<!-- chunk_id: wrap_summary -->
## 1) Executive Fact Summary

### 1.1 Headline
{{ day.market_outcomes.headline_neutral }}

### 1.2 Index / Benchmark Closes
{% for idx in day.market_outcomes.indices %}
- **{{ idx.symbol }}**: {{ "%.2f"|format(idx.close) }} ({{ "%+.2f"|format(idx.return_pct) }}%)
{% if idx.low is defined and idx.high is defined %}
  - Range: {{ "%.2f"|format(idx.low) }} – {{ "%.2f"|format(idx.high) }}
{% endif %}
{% endfor %}

### 1.3 Rates / FX / Commodities
{% if day.market_outcomes.rates_fx_commodities|length == 0 %}
- (none)
{% else %}
{% for r in day.market_outcomes.rates_fx_commodities %}
- **{{ r.symbol }}**: {{ r.value }}{% if r.unit == "pct" %}%{% elif r.unit == "bps" %} bps{% elif r.unit == "usd" %} USD{% elif r.unit == "index" %}{% elif r.unit == "ratio" %}{% endif %}

{% if r.change_bps is defined %}
  - Change: {{ "%+g"|format(r.change_bps) }} bps
{% elif r.symbol == "EURUSD" and r.change_abs is defined and r.change_pct is defined %}
  - Change: {{ "%+g"|format(r.change_abs) }} ({{ "%+g"|format(r.change_pct) }}%)
{% elif r.change_abs is defined %}
  - Change: {{ "%+g"|format(r.change_abs) }}
{% elif r.change_pct is defined %}
  - Change: {{ "%+g"|format(r.change_pct) }}%
{% elif r.change is defined %}
  - Change: {{ "%+g"|format(r.change) }}
{% endif %}
{% endfor %}
{% endif %}

### 1.4 Volatility
{% for v in day.market_outcomes.volatility %}
- **{{ v.symbol }}**: {{ "%.2f"|format(v.close) }}
{% if v.change_pts is defined %}
  - Change: {{ "%+.2f"|format(v.change_pts) }} pts
{% elif v.change is defined %}
  - Change: {{ "%+.2f"|format(v.change) }} pts
{% endif %}
{% endfor %}

### 1.5 Breadth
- Advancers: {{ day.market_outcomes.breadth.advancers }}
- Decliners: {{ day.market_outcomes.breadth.decliners }}
{% if day.market_outcomes.breadth.pct_above_200dma is defined %}
- % above 200DMA: {{ "%.1f"|format(day.market_outcomes.breadth.pct_above_200dma) }}%
{% endif %}

<!-- chunk_id: wrap_timeline -->
## 2) Session Timeline (Attributed Events)

{% for e in (day.events | sort(attribute="published_ts")) %}
### {{ e.published_ts }} — {{ e.event_type }}
- **Event ID**: {{ e.event_id }}
- **Session**: {{ e.market_session }}
- **Entities**: {{ e.entities | join(", ") }}
- **Facts**:
{% for f in e.facts %}
  - {{ f }}
{% endfor %}
- **Source**: {{ e.source.name }} ({{ e.source.source_type }})
- **URL**: {{ e.source.canonical_url }}

{% endfor %}

<!-- chunk_id: wrap_reactions -->
## 3) Measured Market Reactions

### 3.1 Reaction Windows (grouped by event_id)

{% set core = ["SPX","NDX","DJIA","RUT","VIX"] %}
{% set allowed_windows = ["t0_to_t+5m","t0_to_t+30m","t0_to_t+60m","t0_to_close","pre_to_close"] %}
{% set max_extras = 8 %}

{% for e in (day.events | sort(attribute="published_ts")) %}
#### Event {{ e.event_id }}

{% set rows = (day.reaction_windows | selectattr("event_id","equalto",e.event_id) | list) %}

{% set core_rows = rows | selectattr("instrument","in",core) | selectattr("window","in",allowed_windows) | list %}
{% set extra_rows = rows | rejectattr("instrument","in",core) | selectattr("window","in",allowed_windows) | list %}

{% if core_rows|length == 0 and extra_rows|length == 0 %}
- (no reaction windows recorded)
{% else %}

**Core instruments**
{% for rw in core_rows %}
- **{{ rw.instrument }}** — Window {{ rw.window }}: {% if rw.move_pts is defined %}{{ "%+.3f"|format(rw.move_pts) }} pts{% elif rw.move_pct is defined %}{{ "%+.3f"|format(rw.move_pct) }}%{% else %}{{ "%+.3f"|format(rw.move or 0) }}{% endif %}
{% endfor %}

{% if extra_rows|length > 0 %}
**Additional instruments (capped)**
{% for rw in extra_rows[:max_extras] %}
- **{{ rw.instrument }}** — Window {{ rw.window }}: {% if rw.move_pts is defined %}{{ "%+.3f"|format(rw.move_pts) }} pts{% elif rw.move_pct is defined %}{{ "%+.3f"|format(rw.move_pct) }}%{% else %}{{ "%+.3f"|format(rw.move or 0) }}{% endif %}
{% endfor %}
{% endif %}

{% endif %}

{% endfor %}

<!-- chunk_id: wrap_movers_sectors -->
## 4) Movers and Sectors

### 4.1 Top Movers
**Top Gainers**
{% for m in day.movers.top_gainers %}
- {{ m.symbol }}: {{ "%+.2f"|format(m.return_pct) }}% ({{ m.volume_multiple }}× avg volume) — {{ m.sector }}
{% endfor %}

**Top Decliners**
{% for m in day.movers.top_decliners %}
- {{ m.symbol }}: {{ "%+.2f"|format(m.return_pct) }}% ({{ m.volume_multiple }}× avg volume) — {{ m.sector }}
{% endfor %}

### 4.2 Sector Performance
| Sector | Return | Volume Multiple |
|---|---:|---:|
{% for s in day.sectors %}
| {{ s.name }} | {{ "%+.2f"|format(s.return_pct) }}% | {{ "%.2f"|format(s.volume_multiple) }}× |
{% endfor %}

<!-- chunk_id: wrap_ticker_panels -->
## 5) Company Fact Panels

{% for t in day.tickers %}
### {{ t.symbol }}
- **Close**: {{ "%.2f"|format(t.close) }} ({{ "%+.2f"|format(t.return_pct) }}%)
- **Volume**: {{ "%.2f"|format(t.volume_multiple) }}× avg
- **Technicals**:
  - SMA(50): {{ "%.2f"|format(t.technicals.sma_50) }}
  - SMA(200): {{ "%.2f"|format(t.technicals.sma_200) }}
  - RSI(14): {{ "%.1f"|format(t.technicals.rsi_14) }}
- **Company Filings Identified**: {{ "true" if t.filings_identified else "false" }}

{% endfor %}

<!-- chunk_id: wrap_evidence -->
## 6) Evidence Appendix

```yaml
evidence_items:
{% for ev in day.evidence_items %}
  - event_id: {{ ev.event_id }}
    source_name: {{ ev.source_name }}
    source_type: {{ ev.source_type }}
    published_ts: {{ ev.published_ts }}
    canonical_url: "{{ ev.canonical_url }}"
    excerpt: "{{ (ev.excerpt
      | replace('\\\\', '\\\\\\')
      | replace('\"', '\\\"')
      | replace('\\n', ' ')
      | truncate(280, True, '…')
    ) }}"
    doc_id: {{ ev.doc_id }}
    chunk_id: {{ ev.chunk_id }}
{% endfor %}
